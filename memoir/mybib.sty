\NeedsTeXFormat{LaTeX2e}[1999/01/01]
\ProvidesPackage{mybib}[2011/03/28]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Declare package options %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% For the intermediate bibliographies
% What is the section level to print the bibliographies
\xdef\mybib@bibprintlevel{none}
\DeclareOptionX[my]{bibprintlevel}[none]{\xdef\mybib@bibprintlevel{#1}}
% For more powerful command about bibliography citations
\newif\if@natbib \@natbibfalse
\DeclareOptionX[my]{natbib}{\@natbibtrue}
% To have back references (page number) in the bibliographies
\newif\if@backref \@backreffalse
\DeclareOptionX[my]{backref}{\@backreftrue}
% Use the 'biblatex' package
\newif\if@biblatex \@biblatexfalse
\DeclareOptionX[my]{biblatex}{\@biblatextrue}
% In case of unknown options
\DeclareOptionX*{%
	\PackageWarning{mybib}{Unknown option `\CurrentOption'}%
}

\ProcessOptionsX[my]

%% Options to pass to packages
\if@natbib
	\PassOptionsToPackage{natbib}{biblatex}
\fi
\if@backref
	\if@biblatex
		\PassOptionsToPackage{backref}{biblatex}
	\else
		\PassOptionsToPackage{backref}{hyperref}
	\fi
\fi

%% Packages to call
\RequirePackage{etoolbox}
% The biblatex is the best package to make bibliographies
\if@biblatex
	\RequirePackage{csquotes}
	\RequirePackage{biblatex}
\else
	% To generate entry in table of content for bibliographies (and other)
	\RequirePackage{tocbibind}
	% For more powerful command for bibliography citations
	\if@natbib
		\RequirePackage[sort,comma,square]{natbib}
	\fi
	% For seperated bibliographies in sections or chapters
	% Compatible with natbib
\fi

%%%%%%%%%%%%%%%%%%%%%%%
%% New configuration %%
%%%%%%%%%%%%%%%%%%%%%%%
\DefineBibliographyStrings{french}{%
	andothers = {\it et\addabbrvspace al\adddot}%
}

%%%%%%%%%%%%%%%%%%
%% New commands %%
%%%%%%%%%%%%%%%%%%
%% To include a bibliography
\newrobustcmd\mybiblio[1][]{%
	\if@biblatex%
		\clearpage%
		\ifstrempty{#1}%
		{%
			\printbibliography[heading=bibintoc]%
		}{%
			\printbibliography[heading=bibintoc,#1]%
		}%
	\else%
		\bibliographystyle{apalike}%
		\bibliography{biblio}%
	\fi%
}
% Replace the command '\cite'
% Thanks to the 'natbib' package, you can use:
% - \mycite{<ref>} -> [<author>, <year>]
% - \mycite[author]{<ref>} -> <author> [<year>]
\if@biblatex
	\DeclareCiteCommand{\my@mycite}[\mkbibbrackets]%
		{\usebibmacro{cite:init}%
			\usebibmacro{prenote}}%
		{\usebibmacro{citeindex}%
			\usebibmacro{cite}}%
		{}%
		{\usebibmacro{postnote}}
	\DeclareCiteCommand{\my@myciteauthor}%
		{\usebibmacro{cite:init}%
			\usebibmacro{prenote}}%
		{\usebibmacro{citeindex}%
			\printnames{labelname}~\bibopenbracket\usebibmacro{citeyear}\bibclosebracket}%
		{}%
		{\usebibmacro{postnote}}
	\newrobustcmd\mycite[2][]{%
		\ifthenelse{\equal{#1}{author}}%
			{\my@myciteauthor{#2}}%
			{\my@mycite{#2}}%
	}
\else
	\if@natbib
		\newrobustcmd\mycite[2][]{%
			\ifthenelse{\equal{#1}{author}}%
				{\citet{#2}\xspace}%
				{\citep{#2}\xspace}%
		}
	\else
		\newrobustcmd\mycite[2][]{%
			\cite{#2}\xspace%
		}
	\fi
\fi

% End of package
\endinput
